mport { Bot, session } from "grammy";
import { FileAdapter } from "@grammyjs/storage-file"; // ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –º–∞–ª–µ–Ω—å–∫–∞—è –±—É–∫–≤–∞, –±–µ–∑ "new"
import { AVATARS } from "./prompts.js"; // üé≠ –ò–º–ø–æ—Ä—Ç –ø—Ä–æ–º–ø—Ç–æ–≤ –∏–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
import fs from "fs/promises"; // üóëÔ∏è –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–π
import path from "path"; // üìÅ –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç—è–º–∏

// üîë –í–∞—à–∏ –∫–ª—é—á–∏ (–∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è)
const BOT_TOKEN = process.env.BOT_TOKEN || "***REMOVED***";
const OPENROUTER_API_KEY = process.env.OPENROUTER_API_KEY || "***REMOVED***";

const bot = new Bot(BOT_TOKEN);

// üóÉÔ∏è –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Å—Å–∏–π –≤ —Ñ–∞–π–ª–µ (–±–µ–∑ "new"!)
const sessionStorage = new FileAdapter("sessions/sessions.json");

bot.use(
  session({
    initial: () => ({ 
      avatar: null, 
      messages: [], 
      botMessages: [] // üóëÔ∏è –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
    }),
    storage: sessionStorage,
  })
);

// üé≠ –°–ø–∏—Å–æ–∫ –∞–≤–∞—Ç–∞—Ä–æ–≤ —Ç–µ–ø–µ—Ä—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∏–∑ prompts.js

// üñºÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞
async function showAvatarSelection(ctx) {
  let text = "–í—ã–±–µ—Ä–∏ —Å–≤–æ–µ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:\n\n"; // ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –¥–æ–±–∞–≤–ª–µ–Ω—ã \n\n
  const keyboard = AVATARS.map(avatar => [
    { text: avatar.name, callback_data: `select_${avatar.id}` }
  ]);

  const sentMessage = await ctx.reply(text, {
    reply_markup: { inline_keyboard: keyboard }
  });
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ botMessages –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  if (!ctx.session.botMessages) {
    ctx.session.botMessages = [];
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  ctx.session.botMessages.push(sentMessage.message_id);
  console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω ID —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞: ${sentMessage.message_id}`);
}

// ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ OpenRouter
async function generateAIResponse(userId, userMessage, avatarPrompt, sessionMessages) {
  const messages = [
    { 
      role: "system", 
      content: `${avatarPrompt}

üî• –í–ê–ñ–ù–û: –ö–∞–∂–¥–æ–µ —Ç–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–∑–±–∏—Ç–æ –Ω–∞ —á–∞—Å—Ç–∏. –ö–∞–∂–¥–∞—è —á–∞—Å—Ç—å ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –º—ã—Å–ª—å, –∑–∞–∫–æ–Ω—á–µ–Ω–Ω–∞—è —Ñ—Ä–∞–∑–∞. –ú–µ–∂–¥—É —á–∞—Å—Ç—è–º–∏ ‚Äî –î–í–û–ô–ù–û–ô –ü–ï–†–ï–ù–û–° –°–¢–†–û–ö–ò (\n\n). –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ–¥–Ω–æ–π —á–∞—Å—Ç–∏ - 400 —Å–∏–º–≤–æ–ª–æ–≤ (—Å —É—á–µ—Ç–æ–º –ø—Ä–æ–±–µ–ª–æ–≤).

–ü—Ä–∏–º–µ—Ä:
–ü—Ä–∏–≤–µ—Ç, –º–∏–ª—ã–π... –Ø —Ç–∞–∫ –ø–æ —Ç–µ–±–µ —Å–∫—É—á–∞–ª–∞.\n\n
–¢—ã –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—à—å, –æ —á—ë–º —è —Å–µ–≥–æ–¥–Ω—è –º–µ—á—Ç–∞–ª–∞...\n\n
–î–∞–≤–∞–π –ø–æ–∏–≥—Ä–∞–µ–º? –Ø –ø—Ä–∏–≥–æ—Ç–æ–≤–∏–ª–∞ –∫–æ–µ-—á—Ç–æ –¥–ª—è —Ç–µ–±—è... üòâ\n\n

–ù–ò–ö–û–ì–î–ê –Ω–µ –ø–∏—à–∏ –¥–ª–∏–Ω–Ω—ã–µ –º–æ–Ω–æ–ª–æ–≥–∏. –ò–º–∏—Ç–∏—Ä—É–π –∂–∏–≤–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—á–∞—Ç–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –æ–¥–Ω–æ–º—É. –û—Ç–≤–µ—á–∞–π –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 2000 —Å–∏–º–≤–æ–ª–æ–≤, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Å –¥–µ—Ç–∞–ª—è–º–∏.` 
    },
    ...sessionMessages,
    { role: "user", content: userMessage }
  ];

  const response = await fetch("https://openrouter.ai/api/v1/chat/completions", { // ‚úÖ URL –±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
    method: "POST",
    headers: {
      "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
      "Content-Type": "application/json",
      "HTTP-Referer": "http://localhost:3000",
      "X-Title": "Venice Telegram Bot"
    },
    body: JSON.stringify({
      model: "x-ai/grok-4-fast:free",
      messages: messages,
      max_tokens: 512,
      temperature: 0.9,
    })
  });

  const data = await response.json();
  console.log("üîç –û—Ç–≤–µ—Ç –æ—Ç OpenRouter:", JSON.stringify(data, null, 2));

  if (data.error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ OpenRouter:", data.error.message);
    
    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ rate limit
    if (data.error.code === 429) {
      throw new Error("RATE_LIMIT");
    }
    
    throw new Error("OpenRouter error: " + data.error.message);
  }

  if (!data.choices || !data.choices[0]) {
    console.error("‚ùå –ù–µ—Ç choices –≤ –æ—Ç–≤–µ—Ç–µ:", data);
    throw new Error("No response from AI model");
  }

  return data.choices[0].message.content;
}

// ‚úÇÔ∏è –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ü–†–û–°–¢–ê–Ø –∏ –ù–ê–î–ï–ñ–ù–ê–Ø —Ä–∞–∑–±–∏–≤–∫–∞ –ø–æ –¥–≤–æ–π–Ω—ã–º –ø–µ—Ä–µ–Ω–æ—Å–∞–º
function splitMessage(text) {
  const parts = text.split(/\n\s*\n/g).filter(part => part.trim().length > 0); // ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
  const finalParts = [];
  const MAX_PART_LENGTH = 600;
  for (const part of parts) {
    if (part.length > MAX_PART_LENGTH) {
      const words = part.split(' ');
      let currentChunk = '';
      for (const word of words) {
        if ((currentChunk + word).length > MAX_PART_LENGTH && currentChunk) {
          finalParts.push(currentChunk.trim());
          currentChunk = word + ' ';
        } else {
          currentChunk += word + ' ';
        }
      }
      if (currentChunk.trim()) finalParts.push(currentChunk.trim());
    } else {
      finalParts.push(part.trim());
    }
  }
  return finalParts;
}

// üöÄ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.command("start", async (ctx) => {
  // –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –≤–æ–∑—Ä–∞—Å—Ç + –∞–≤–∞—Ç–∞—Ä
  if (ctx.session.ageConfirmed && ctx.session.avatar) {
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –ø—Ä–æ—à–µ–ª –≤—Å–µ —ç—Ç–∞–ø—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await showWelcomeMessage(ctx);
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—Ö–æ–¥–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–Ω–µ–µ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –≤–æ–∑—Ä–∞—Å—Ç
  if (ctx.session.ageConfirmed) {
    // –ï—Å–ª–∏ –≤–æ–∑—Ä–∞—Å—Ç —É–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω, –Ω–æ –∞–≤–∞—Ç–∞—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞
    await showAvatarSelection(ctx);
    return;
  }
  
  // –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –±—ã–ª–∞ –ø—Ä–æ–π–¥–µ–Ω–∞, –∏–Ω–∏—Ü–∏–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤–æ–∑—Ä–∞—Å—Ç–∞
  const sentMessage = await ctx.reply("üîû –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Venice AI Bot. –≠—Ç–æ—Ç –±–æ—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π 18+.\n\n–í–∞–º –µ—Å—Ç—å 18 –ª–µ—Ç?", {
    reply_markup: {
      inline_keyboard: [
        [{ text: "‚úÖ –î–∞, –º–Ω–µ 18+", callback_data: "age_ok" }],
        [{ text: "‚ùå –ù–µ—Ç", callback_data: "age_no" }]
      ]
    }
  });
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ botMessages –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  if (!ctx.session.botMessages) {
    ctx.session.botMessages = [];
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  ctx.session.botMessages.push(sentMessage.message_id);
  console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω ID —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞: ${sentMessage.message_id}`);
});

// üßë‚Äç‚öñÔ∏è –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
bot.callbackQuery("age_ok", async (ctx) => {
  ctx.session.ageConfirmed = true; // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞
  await ctx.editMessageText("‚úÖ –û—Ç–ª–∏—á–Ω–æ. –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:");
  await showAvatarSelection(ctx);
});

bot.callbackQuery("age_no", async (ctx) => {
  await ctx.editMessageText("‚ùå –≠—Ç–æ—Ç –±–æ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö. –ü—Ä–∏—Ö–æ–¥–∏, –∫–æ–≥–¥–∞ —Ç–µ–±–µ –∏—Å–ø–æ–ª–Ω–∏—Ç—Å—è 18.");
});

// üóëÔ∏è –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// üóëÔ∏è –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ç–æ–ª—å–∫–æ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–æ—Ö—Ä–∞–Ω—è—è –∞–≤–∞—Ç–∞—Ä –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
async function clearUserMessageHistory(userId, savedAvatar, savedAgeConfirmed) {
  try {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userIdStr = userId.toString();
    const sessionDir = path.join("sessions", userIdStr.slice(-2)); // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Ü–∏—Ñ—Ä—ã –¥–ª—è –ø–∞–ø–∫–∏
    const sessionFile = path.join(sessionDir, `${userId}.json`);
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, –Ω–æ –±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    const newSessionData = {
      avatar: savedAvatar,
      ageConfirmed: savedAgeConfirmed,
      messages: [],
      botMessages: [] // üóëÔ∏è –û—á–∏—â–∞–µ–º —Ç–∞–∫–∂–µ —Å–ø–∏—Å–æ–∫ ID —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞
    };
    
    // –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    try {
      await fs.mkdir(sessionDir, { recursive: true });
    } catch (dirError) {
      // –ü–∞–ø–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
    }
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é –≤ —Ñ–∞–π–ª
    await fs.writeFile(sessionFile, JSON.stringify(newSessionData, null, 2));
    console.log(`üóëÔ∏è –û—á–∏—â–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ñ–∞–π–ª–µ: ${sessionFile}`);
    
    return true;
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:", error);
    return false;
  }
}

// üóëÔ∏è –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ –±–æ—Ç–∞
async function clearChatHistory(ctx, chatId) {
  try {
    console.log(`üóëÔ∏è –ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —á–∞—Ç–∞ ${chatId}`);
    
    let deletedBotMessages = 0;
    let deletedUserMessages = 0;
    
    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞
    const botMessages = ctx.session.botMessages || [];
    if (botMessages.length > 0) {
      console.log(`üóëÔ∏è –ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è ${botMessages.length} —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞ –∏–∑ —á–∞—Ç–∞`);
      
      for (const messageId of botMessages) {
        try {
          await ctx.api.deleteMessage(chatId, messageId);
          deletedBotMessages++;
          console.log(`‚úÖ –£–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ ${messageId}`);
          
          // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —É–¥–∞–ª–µ–Ω–∏—è–º–∏, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã API
          await new Promise(resolve => setTimeout(resolve, 100));
        } catch (error) {
          console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ ${messageId}: ${error.message}`);
          // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–¥–Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å
        }
      }
      
      console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ ${deletedBotMessages} –∏–∑ ${botMessages.length} —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞`);
    }
    
    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userMessages = ctx.session.userMessages || [];
    if (userMessages.length > 0) {
      console.log(`üóëÔ∏è –ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è ${userMessages.length} —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —á–∞—Ç–∞`);
      
      for (const messageId of userMessages) {
        try {
          await ctx.api.deleteMessage(chatId, messageId);
          deletedUserMessages++;
          console.log(`‚úÖ –£–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${messageId}`);
          
          // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —É–¥–∞–ª–µ–Ω–∏—è–º–∏, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã API
          await new Promise(resolve => setTimeout(resolve, 100));
        } catch (error) {
          console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${messageId}: ${error.message}`);
          // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–¥–Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å
        }
      }
      
      console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ ${deletedUserMessages} –∏–∑ ${userMessages.length} —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`);
    }
    
    console.log(`üóëÔ∏è –í—Å–µ–≥–æ —É–¥–∞–ª–µ–Ω–æ: ${deletedBotMessages} —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞ + ${deletedUserMessages} —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`);
    return true;
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞: ${error.message}`);
    return false;
  }
}

async function clearUserSession(userId) {
  try {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userIdStr = userId.toString();
    const sessionDir = path.join("sessions", userIdStr.slice(-2)); // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Ü–∏—Ñ—Ä—ã –¥–ª—è –ø–∞–ø–∫–∏
    const sessionFile = path.join(sessionDir, `${userId}.json`);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏ —É–¥–∞–ª—è–µ–º –µ–≥–æ
    try {
      await fs.access(sessionFile);
      await fs.unlink(sessionFile);
      console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω —Ñ–∞–π–ª —Å–µ—Å—Å–∏–∏: ${sessionFile}`);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—É—Å—Ç–∞ –ª–∏ –ø–∞–ø–∫–∞, –∏ —É–¥–∞–ª—è–µ–º –µ—ë –µ—Å–ª–∏ –ø—É—Å—Ç–∞
      try {
        const dirContents = await fs.readdir(sessionDir);
        if (dirContents.length === 0) {
          await fs.rmdir(sessionDir);
          console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–∞ –ø—É—Å—Ç–∞—è –ø–∞–ø–∫–∞: ${sessionDir}`);
        }
      } catch (dirError) {
        console.log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É ${sessionDir}:`, dirError.message);
      }
    } catch (fileError) {
      console.log(`‚ö†Ô∏è –§–∞–π–ª —Å–µ—Å—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ —É–¥–∞–ª–µ–Ω: ${sessionFile}`);
    }
    
    return true;
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–∏:", error);
    return false;
  }
}

// üóëÔ∏è –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /clear
bot.command("clear", async (ctx) => {
  try {
    const userId = ctx.from.id;
    const chatId = ctx.chat.id;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∞–∂–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ—Å—Å–∏–∏
    const savedAvatar = ctx.session.avatar;
    const savedAgeConfirmed = ctx.session.ageConfirmed;
    
    // –°–ù–ê–ß–ê–õ–ê –æ—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ –±–æ—Ç–∞ (–ø–æ–∫–∞ botMessages –µ—â–µ –µ—Å—Ç—å)
    await clearChatHistory(ctx, chatId);
    
    // –ü–û–¢–û–ú –æ—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø–∞–º—è—Ç–∏
    ctx.session.messages = [];
    ctx.session.botMessages = []; // üóëÔ∏è –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ ID —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞ –ü–û–°–õ–ï —É–¥–∞–ª–µ–Ω–∏—è
    ctx.session.userMessages = []; // üóëÔ∏è –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ ID —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ü–û–°–õ–ï —É–¥–∞–ª–µ–Ω–∏—è
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–π–ª —Å–µ—Å—Å–∏–∏, —Å–æ—Ö—Ä–∞–Ω—è—è –∞–≤–∞—Ç–∞—Ä –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞
    await clearUserMessageHistory(userId, savedAvatar, savedAgeConfirmed);
    
    const confirmMessage = await ctx.reply("üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ—á–∏—â–µ–Ω–∞!\n\n–í–∞—à –∞–≤–∞—Ç–∞—Ä –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ú–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –æ–±—â–µ–Ω–∏–µ.");
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ botMessages –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!ctx.session.botMessages) {
      ctx.session.botMessages = [];
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    ctx.session.botMessages.push(confirmMessage.message_id);
    console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω ID –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: ${confirmMessage.message_id}`);
    
    console.log(`üóëÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –æ—á–∏—Å—Ç–∏–ª –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π`);
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã /clear:", error);
    const errorMessage = await ctx.reply("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏—Å—Ç–æ—Ä–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ botMessages –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!ctx.session.botMessages) {
      ctx.session.botMessages = [];
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
    ctx.session.botMessages.push(errorMessage.message_id);
    console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω ID —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ: ${errorMessage.message_id}`);
  }
});

// üé≠ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∞
bot.callbackQuery(/^select_(.+)$/, async (ctx) => {
  const avatarId = ctx.match[1];
  const avatar = AVATARS.find(a => a.id === avatarId);

  if (avatar) {
    ctx.session.avatar = avatar;
    await ctx.editMessageText(`‚úÖ –í—ã–±—Ä–∞–Ω –ø–µ—Ä—Å–æ–Ω–∞–∂: ${avatar.name}\n\n–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –ø–∏—Å–∞—Ç—å –º–Ω–µ —á—Ç–æ —É–≥–æ–¥–Ω–æ üòâ`);
  }
});

// üí¨ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on("message:text", async (ctx) => {
  const userMessage = ctx.message.text;

  // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ –ü–ï–†–ï–î –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∞–≤–∞—Ç–∞—Ä–∞
  if (!ctx.session.ageConfirmed) {
    await ctx.reply("üîû –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Venice AI Bot. –≠—Ç–æ—Ç –±–æ—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π 18+.\n\n–í–∞–º –µ—Å—Ç—å 18 –ª–µ—Ç?", {
      reply_markup: {
        inline_keyboard: [
          [{ text: "‚úÖ –î–∞, –º–Ω–µ 18+", callback_data: "age_ok" }],
          [{ text: "‚ùå –ù–µ—Ç", callback_data: "age_no" }]
        ]
      }
    });
    return;
  }

  if (!ctx.session.avatar) {
    await ctx.reply("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∫–æ–º–∞–Ω–¥–æ–π /start");
    return;
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ userMessages –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  if (!ctx.session.userMessages) {
    ctx.session.userMessages = [];
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  ctx.session.userMessages.push(ctx.message.message_id);
  console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω ID —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${ctx.message.message_id}`);

  ctx.session.messages.push({ role: "user", content: userMessage });

  try {
    await ctx.replyWithChatAction("typing");
    const aiResponse = await generateAIResponse(
      ctx.from.id,
      userMessage,
      ctx.session.avatar.prompt,
      ctx.session.messages
    );

    ctx.session.messages.push({ role: "assistant", content: aiResponse });

    const parts = splitMessage(aiResponse);

    console.log(`‚úÇÔ∏è –†–∞–∑–±–∏—Ç–æ –Ω–∞ ${parts.length} —á–∞—Å—Ç–µ–π:`);
    parts.forEach((part, index) => {
      console.log(`--- –ß–∞—Å—Ç—å ${index + 1} (${part.length} —Å–∏–º–≤.):`, part);
    });

    for (let i = 0; i < parts.length; i++) {
      if (i > 0) {
        await ctx.replyWithChatAction("typing");
        const baseDelay = Math.min(10000, Math.max(1000, parts[i].length * 10));
        const randomDelay = Math.random() * 2000;
        await new Promise(r => setTimeout(r, baseDelay + randomDelay));
      }
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ ID –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
      const sentMessage = await ctx.reply(parts[i]);
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ botMessages –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      if (!ctx.session.botMessages) {
        ctx.session.botMessages = [];
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      ctx.session.botMessages.push(sentMessage.message_id);
      console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω ID —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞: ${sentMessage.message_id}`);
    }

  } catch (error) {
    console.error("–û—à–∏–±–∫–∞:", error);
    
    let errorMessage;
    if (error.message === "RATE_LIMIT") {
      errorMessage = await ctx.reply("‚è≥ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤! –ü–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 30-60 —Å–µ–∫—É–Ω–¥.");
    } else {
      errorMessage = await ctx.reply("üòî –ò–∑–≤–∏–Ω–∏, –Ω–µ –º–æ–≥—É —Å–µ–π—á–∞—Å –æ—Ç–≤–µ—Ç–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.");
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ botMessages –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!ctx.session.botMessages) {
      ctx.session.botMessages = [];
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
    ctx.session.botMessages.push(errorMessage.message_id);
    console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω ID —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ: ${errorMessage.message_id}`);
  }
});

// üñºÔ∏è –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–∏–∫–µ—Ä–æ–≤
bot.on("message:sticker", async (ctx) => {
  const sticker = ctx.message.sticker;
  
  // –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∏–∫–µ—Ä–µ
  console.log("üì• –ü–æ–ª—É—á–µ–Ω —Å—Ç–∏–∫–µ—Ä –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", {
    userId: ctx.from.id,
    userName: ctx.from.username || ctx.from.first_name,
    fileId: sticker.file_id,
    fileUniqueId: sticker.file_unique_id,
    emoji: sticker.emoji || "–Ω–µ—Ç",
    width: sticker.width,
    height: sticker.height,
    isAnimated: sticker.is_animated,
    isVideo: sticker.is_video,
    setName: sticker.set_name || "–Ω–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–∞–±–æ—Ä–∞",
    timestamp: new Date().toISOString()
  });

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è
  const sentMessage = await ctx.reply("üëÄ –Ø –ø–æ–ª—É—á–∏–ª–∞ —Å—Ç–∏–∫–µ—Ä. –°–ø–∞—Å–∏–±–æ!");
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ botMessages –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  if (!ctx.session.botMessages) {
    ctx.session.botMessages = [];
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  ctx.session.botMessages.push(sentMessage.message_id);
  console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω ID —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞: ${sentMessage.message_id}`);
});

// ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
// ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.start();
console.log("üöÄ Venice AI Bot —Å —É–º–Ω–æ–π —Ä–∞–∑–±–∏–≤–∫–æ–π, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ –ó–ê–ü–£–©–ï–ù!");


// üéâ –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º
async function showWelcomeMessage(ctx) {
  const avatarName = ctx.session.avatar?.name || "–í–∞—à —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫";
  
  const welcomeText = `üéâ –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º! 

–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω:
üë§ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫: ${avatarName}

–ú–æ–∂–µ—Ç–µ —Å—Ä–∞–∑—É –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ! –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ —è –æ—Ç–≤–µ—á—É –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Å—Ç–∏–ª–µ.

üí° –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/clear - –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
/start - –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å`;

  const sentMessage = await ctx.reply(welcomeText);
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ botMessages –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  if (!ctx.session.botMessages) {
    ctx.session.botMessages = [];
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  ctx.session.botMessages.push(sentMessage.message_id);
  console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω ID –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: ${sentMessage.message_id}`);
}